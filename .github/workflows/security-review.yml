name: AI Security Review

on:
  workflow_call:
    inputs:
      fail_on_critical:
        description: 'Fail the workflow if CRITICAL issues are found'
        type: boolean
        default: true
      fail_on_high:
        description: 'Fail the workflow if HIGH issues are found'
        type: boolean
        default: false
    secrets:
      GEMINI_API_KEY:
        required: true

jobs:
  security-review:
    name: AI Security Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install google-genai

      - name: Get changed files
        id: changed
        run: |
          BASE_REF="${{ github.base_ref }}"
          if [ -z "$BASE_REF" ]; then
            BASE_REF="main"
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${BASE_REF}...HEAD >> $GITHUB_OUTPUT || echo "Unable to get diff" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get diff content
        id: diff
        run: |
          BASE_REF="${{ github.base_ref }}"
          if [ -z "$BASE_REF" ]; then
            BASE_REF="main"
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          git diff origin/${BASE_REF}...HEAD >> $GITHUB_OUTPUT || echo "Unable to get diff" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run AI Security Review
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
          DIFF_CONTENT: ${{ steps.diff.outputs.content }}
        run: |
          python << 'SCRIPT'
          import os
          import json
          from google import genai

          api_key = os.environ.get("GEMINI_API_KEY")
          changed_files = os.environ.get("CHANGED_FILES", "")
          diff_content = os.environ.get("DIFF_CONTENT", "")

          if not diff_content.strip():
              print("No code changes to review")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("result=NO_CHANGES\n")
              exit(0)

          # Read security rules if exists
          rules = ""
          rules_path = ".github/SECURITY_RULES.md"
          if os.path.exists(rules_path):
              with open(rules_path) as f:
                  rules = f.read()

          client = genai.Client(api_key=api_key)

          prompt = f"""You are a security expert. Analyze the following code changes for security vulnerabilities.

          ## Security Rules
          {rules}

          ## Changed Files
          {changed_files}

          ## Code Changes (Diff)
          ```diff
          {diff_content}
          ```

          ## Analysis Instructions

          For each finding, respond in this format:

          ### [SEVERITY] Title
          - **File:** filename:line_number
          - **Issue:** Brief description of the issue
          - **Risk:** How this vulnerability could be exploited
          - **Recommendation:** How to fix it
          - **Code Example:** (if applicable, show fixed code)

          Severity levels:
          - ðŸ”´ **CRITICAL**: Immediate action required (injection, auth bypass, credential leak)
          - ðŸŸ  **HIGH**: Significant security risk (missing validation, CORS issues)
          - ðŸŸ¡ **MEDIUM**: Moderate risk (verbose errors, weak crypto)
          - ðŸ”µ **LOW**: Low risk, improvement suggestion (code quality, best practices)

          If no security issues are found:
          âœ… **Security scan completed - No issues found**

          Only report real security issues. Avoid false positives.
          DO NOT make code quality or style suggestions, focus only on security.
          """

          try:
              response = client.models.generate_content(
                  model="gemini-2.0-flash",
                  contents=prompt
              )
              result = response.text
              print(result)

              # Save result for PR comment
              with open("security_review.md", "w") as f:
                  f.write("## ðŸ”’ AI Security Review\n\n")
                  f.write(result)
                  f.write("\n\n---\n*Automated security review powered by Gemini AI*")

              # Check for critical/high severity issues
              has_critical = "CRITICAL" in result or "ðŸ”´" in result
              has_high = "HIGH" in result or "ðŸŸ " in result

              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("result=COMPLETED\n")
                  f.write(f"has_critical={str(has_critical).lower()}\n")
                  f.write(f"has_high={str(has_high).lower()}\n")

          except Exception as e:
              print(f"Error: {e}")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("result=ERROR\n")
              exit(1)
          SCRIPT

      - name: Post PR Comment
        if: steps.review.outputs.result == 'COMPLETED'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('security_review.md', 'utf8');

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('AI Security Review')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: review
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: review
              });
            }

      - name: Fail on Critical Issues
        if: inputs.fail_on_critical && steps.review.outputs.has_critical == 'true'
        run: |
          echo "::error::CRITICAL security issues found! Review must be addressed before merging."
          exit 1

      - name: Fail on High Issues
        if: inputs.fail_on_high && steps.review.outputs.has_high == 'true'
        run: |
          echo "::error::HIGH severity security issues found! Review must be addressed before merging."
          exit 1

      - name: Warn on High Issues
        if: steps.review.outputs.has_high == 'true' && !inputs.fail_on_high
        run: |
          echo "::warning::HIGH severity security issues found. Please review the comments."
